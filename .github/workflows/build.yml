name: Build GetIPviaWEB Service
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 支持手动触发

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # 适配你的Go版本（建议1.19+）
          cache: true # 启用Go模块缓存，加速编译

      - name: 测试读取 GitHub Secrets（临时暴露明文）
        run: |
          # 将Secret注入环境变量并打印明文（仅测试用，测试后立即删除）
          $env:TEST_API_KEY = "${{ secrets.IP_REPORT_API_KEY }}"
          if ($env:TEST_API_KEY -eq "") {
              echo "❌ 读取Secret失败：IP_REPORT_API_KEY 为空，请检查Secrets配置"
              exit 1
          } else {
              echo "✅ 读取Secret成功，APIKey长度：$($env:TEST_API_KEY.Length) 字符"
          }

      - name: 修复模块校验和并整理依赖
        run: |
          # 核心：清理本地模块缓存，解决校验和不匹配问题
          go clean -modcache
          # 重新整理依赖（基于已有go.mod，更新go.sum为最新校验和）
          go mod tidy

      - name: 编译可执行文件（注入APIKey）
        run: |
          # 注入GitHub Secrets中的APIKey到二进制文件
          go build -o GetIPviaWEB.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          # 验证编译产物
          if (Test-Path "GetIPviaWEB.exe") {
              echo "✅ 编译成功，文件大小：$(Get-Item GetIPviaWEB.exe | Select-Object -ExpandProperty Length) 字节"
          } else {
              echo "❌ 编译失败，未生成可执行文件"
              exit 1
          }

      - name: 安装 Inno Setup（Windows 安装包编译器）
        run: |
          # 使用 Chocolatey 安装 Inno Setup（Windows 官方包管理器）
          choco install innosetup -y --no-progress
          # 验证安装是否成功
          if (Get-Command "ISCC.exe" -ErrorAction SilentlyContinue) {
              echo "✅ Inno Setup 安装成功，版本：$(ISCC.exe /version)"
          } else {
              echo "❌ Inno Setup 安装失败"
              exit 1
          }

      - name: 生成 Inno Setup 安装包脚本（已删除4行发布者配置）
        run: |
          # 写入 Inno Setup 配置脚本（.iss），删除了AppPublisher等4行配置
          @'
          [Setup]
          AppName=GetIPviaWEB Service
          AppVersion=1.0.0
          DefaultDirName={autopf}\GetIPviaWEB
          DefaultGroupName=GetIPviaWEB
          OutputDir=./installer
          OutputBaseFilename=GetIPviaWEB-Setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=lowest

          [Files]
          Source: "GetIPviaWEB.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"
          Name: "{commondesktop}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"; Flags: createonlyiffileexists

          [Run]
          Filename: "{app}\GetIPviaWEB.exe"; Description: "启动 GetIPviaWEB 服务"; Flags: postinstall skipifsilent

          [UninstallRun]
          Filename: "{app}\GetIPviaWEB.exe"; Parameters: "/uninstall"; Flags: skipifdoesntexist

          [UninstallDelete]
          Type: filesandordirs; Name: "{app}"
          '@ | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8
          echo "✅ Inno Setup 脚本生成完成（已删除4行发布者配置）"

      - name: 编译图形化安装包
        run: |
          # 创建安装包输出目录
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          # 调用 Inno Setup 编译器编译安装包
          ISCC.exe GetIPviaWEB.iss
          # 验证安装包是否生成
          $setupFile = "./installer/GetIPviaWEB-Setup.exe"
          if (Test-Path $setupFile) {
              echo "✅ 安装包编译成功，文件大小：$(Get-Item $setupFile | Select-Object -ExpandProperty Length) 字节"
          } else {
              echo "❌ 安装包编译失败，未生成安装文件"
              exit 1
          }

      - name: 上传可执行文件产物
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Exe
          path: GetIPviaWEB.exe
          retention-days: 7

      - name: 上传图形化安装包产物
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Setup
          path: ./installer/GetIPviaWEB-Setup.exe
          retention-days: 7