name: Build GetIPviaWEB Service
on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    # å¼€å¯shellæ‰§è¡Œè·Ÿè¸ªï¼Œæ‰“å°æ‰€æœ‰å‘½ä»¤æ‰§è¡Œæ—¥å¿—ï¼ˆä¾¿äºå®šä½æŠ¥é”™ï¼‰
    defaults:
      run:
        shell: pwsh
        working-directory: .
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        id: checkout
        continue-on-error: false

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
        id: setup-go
        continue-on-error: false

      - name: éªŒè¯ GitHub Secrets æ˜¯å¦é…ç½®
        run: |
          Write-Host "ğŸ” æ£€æŸ¥IP_REPORT_API_KEYé…ç½®çŠ¶æ€"
          if ("${{ secrets.IP_REPORT_API_KEY }}" -eq "") {
              Write-Error "âŒ IP_REPORT_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“Secretsä¸­æ·»åŠ è¯¥å¯†é’¥"
              exit 1
          } else {
              Write-Host "âœ… IP_REPORT_API_KEY é…ç½®æ­£å¸¸"
          }
        id: check-secret
        continue-on-error: false

      - name: ä¿®å¤æ¨¡å—æ ¡éªŒå’Œå¹¶æ•´ç†ä¾èµ–
        run: |
          Write-Host "ğŸ”§ æ¸…ç†Goæ¨¡å—ç¼“å­˜å¹¶æ•´ç†ä¾èµ–"
          go clean -modcache
          go mod tidy
          if ($LASTEXITCODE -ne 0) {
              Write-Error "âŒ go mod tidy æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          Write-Host "âœ… ä¾èµ–æ•´ç†å®Œæˆ"
        id: fix-mod
        continue-on-error: false

      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ³¨å…¥APIKeyï¼‰
        run: |
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘Goç¨‹åºï¼ˆæ³¨å…¥APIKeyï¼‰"
          go build -o GetIPviaWEB.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          if ($LASTEXITCODE -ne 0) {
              Write-Error "âŒ Goç¨‹åºç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          # éªŒè¯ç¼–è¯‘äº§ç‰©
          if (Test-Path "GetIPviaWEB.exe") {
              $fileSize = (Get-Item GetIPviaWEB.exe).Length
              Write-Host "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
          } else {
              Write-Error "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”ŸæˆGetIPviaWEB.exe"
              exit 1
          }
        id: build-exe
        continue-on-error: false

      - name: å®‰è£…/éªŒè¯ Inno Setup
        run: |
          Write-Host "ğŸ”§ æ£€æŸ¥Inno Setupå®‰è£…çŠ¶æ€"
          # æ£€æŸ¥ISCCæ˜¯å¦å­˜åœ¨
          $isccExists = $false
          try {
              Get-Command "ISCC.exe" -ErrorAction Stop | Out-Null
              $isccExists = $true
          } catch {
              $isccExists = $false
          }

          if (-not $isccExists) {
              Write-Host "ğŸ”§ Inno Setupæœªå®‰è£…ï¼Œå¼€å§‹é€šè¿‡Chocolateyå®‰è£…..."
              choco install innosetup -y --no-progress --force
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "âŒ Chocolateyå®‰è£…Inno Setupå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
                  exit 1
              }
          } else {
              Write-Host "âœ… Inno Setupå·²é¢„è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          }

          # éªŒè¯ISCCå¯ç”¨æ€§
          try {
              & ISCC.exe /? 2>&1 | Out-Null
              Write-Host "âœ… Inno SetupéªŒè¯æˆåŠŸï¼ˆå¯æ­£å¸¸è°ƒç”¨ISCCç¼–è¯‘å™¨ï¼‰"
          } catch {
              Write-Error "âŒ Inno SetupéªŒè¯å¤±è´¥ï¼Œå¼‚å¸¸ä¿¡æ¯ï¼š$_"
              exit 1
          }
        id: check-inno
        continue-on-error: false

      - name: ç”Ÿæˆ Inno Setup å®‰è£…åŒ…è„šæœ¬
        run: |
          Write-Host "ğŸ”§ ç”ŸæˆInno Setupé…ç½®è„šæœ¬ï¼ˆGetIPviaWEB.issï¼‰"
          # å†™å…¥ISSè„šæœ¬ï¼ˆç¡®ä¿ç¼–ç æ­£ç¡®ï¼Œæ¢è¡Œç¬¦å…¼å®¹ï¼‰
          $issContent = @'
[Setup]
AppName=GetIPviaWEB Service
AppVersion=1.0.0
DefaultDirName={autopf}\GetIPviaWEB
DefaultGroupName=GetIPviaWEB
OutputDir=./installer
OutputBaseFilename=GetIPviaWEB-Setup
Compression=lzma
SolidCompression=yes
PrivilegesRequired=lowest

[Files]
Source: "GetIPviaWEB.exe"; DestDir: "{app}"; Flags: ignoreversion

[Icons]
Name: "{group}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"
Name: "{commondesktop}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"; Flags: createonlyiffileexists

[Run]
Filename: "{app}\GetIPviaWEB.exe"; Description: "å¯åŠ¨ GetIPviaWEB æœåŠ¡"; Flags: postinstall skipifsilent

[UninstallRun]
Filename: "{app}\GetIPviaWEB.exe"; Parameters: "/uninstall"; Flags: skipifdoesntexist

[UninstallDelete]
Type: filesandordirs; Name: "{app}"
'@
          # å†™å…¥æ–‡ä»¶ï¼ˆä½¿ç”¨CRLFæ¢è¡Œç¬¦ï¼Œå…¼å®¹Inno Setupï¼‰
          $issContent | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -NewLine CRLF
          
          # éªŒè¯ISSæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if (Test-Path "GetIPviaWEB.iss") {
              $fileSize = (Get-Item GetIPviaWEB.iss).Length
              Write-Host "âœ… ISSè„šæœ¬ç”ŸæˆæˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
          } else {
              Write-Error "âŒ ISSè„šæœ¬ç”Ÿæˆå¤±è´¥ï¼Œæœªåˆ›å»ºGetIPviaWEB.iss"
              exit 1
          }
        id: generate-iss
        continue-on-error: false

      - name: ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…
        run: |
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…"
          # åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆç¡®ä¿å­˜åœ¨ï¼‰
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          
          # è·å–ISSè„šæœ¬ç»å¯¹è·¯å¾„
          $issPath = (Resolve-Path GetIPviaWEB.iss).Path
          Write-Host "ğŸ”§ ISSè„šæœ¬ç»å¯¹è·¯å¾„ï¼š$issPath"
          
          # æ‰§è¡ŒISCCç¼–è¯‘ï¼ˆæ‰“å°è¯¦ç»†æ—¥å¿—ï¼‰
          Write-Host "ğŸ”§ æ‰§è¡Œå‘½ä»¤ï¼šISCC.exe /O`"./installer`" /F`"GetIPviaWEB-Setup`" `"$issPath`""
          & ISCC.exe /O"./installer" /F"GetIPviaWEB-Setup" "$issPath"
          $compileExitCode = $LASTEXITCODE
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if ($compileExitCode -eq 0) {
              $setupFile = "./installer/GetIPviaWEB-Setup.exe"
              if (Test-Path $setupFile) {
                  $fileSize = (Get-Item $setupFile).Length
                  Write-Host "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
              } else {
                  Write-Error "âŒ ISCCç¼–è¯‘é€€å‡ºç ä¸º0ï¼Œä½†æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶ï¼š$setupFile"
                  exit 1
              }
          } else {
              Write-Error "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼ŒISCCé€€å‡ºç ï¼š$compileExitCode"
              exit 1
          }
        id: build-installer
        continue-on-error: false

      - name: ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Exe
          path: GetIPviaWEB.exe
          retention-days: 7
        id: upload-exe
        continue-on-error: false

      - name: ä¸Šä¼ å›¾å½¢åŒ–å®‰è£…åŒ…äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Setup
          path: ./installer/GetIPviaWEB-Setup.exe
          retention-days: 7
        id: upload-installer
        continue-on-error: false

      - name: æœ€ç»ˆç»“æœç¡®è®¤
        run: |
          Write-Host "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          Write-Host "âœ… Goç¨‹åºç¼–è¯‘æˆåŠŸï¼š$(Test-Path GetIPviaWEB.exe)"
          Write-Host "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼š$(Test-Path ./installer/GetIPviaWEB-Setup.exe)"
        id: final-check
        continue-on-error: false