name: Build IPReportService
on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
        working-directory: .
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        id: checkout

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
        id: setup-go

      - name: éªŒè¯ GitHub Secrets æ˜¯å¦é…ç½®
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ” æ£€æŸ¥IP_REPORT_API_KEYé…ç½®çŠ¶æ€"
          if ("${{ secrets.IP_REPORT_API_KEY }}" -eq "") {
              Write-Host "âŒ IP_REPORT_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“Secretsä¸­æ·»åŠ è¯¥å¯†é’¥"
              exit 1
          } else {
              Write-Host "âœ… IP_REPORT_API_KEY é…ç½®æ­£å¸¸"
          }
        id: check-secret

      - name: ä¿®å¤æ¨¡å—æ ¡éªŒå’Œå¹¶æ•´ç†ä¾èµ–
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ æ¸…ç†Goæ¨¡å—ç¼“å­˜å¹¶æ•´ç†ä¾èµ–"
          go clean -modcache
          go mod tidy
          if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ go mod tidy æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          Write-Host "âœ… ä¾èµ–æ•´ç†å®Œæˆ"
        id: fix-mod

      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ³¨å…¥APIKeyï¼‰
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘Goç¨‹åºï¼ˆæ³¨å…¥APIKeyï¼‰"
          go build -o IPReportService.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ Goç¨‹åºç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          if (Test-Path "IPReportService.exe") {
              $fileSize = (Get-Item IPReportService.exe).Length
              Write-Host "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
          } else {
              Write-Host "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”ŸæˆIPReportService.exe"
              exit 1
          }
        id: build-exe

      - name: å®‰è£…/éªŒè¯ Inno Setup
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ æ£€æŸ¥Inno Setupå®‰è£…çŠ¶æ€"
          $isccExists = $false
          try {
              Get-Command "ISCC.exe" -ErrorAction SilentlyContinue | Out-Null
              $isccExists = $true
          } catch {
              $isccExists = $false
          }

          if (-not $isccExists) {
              Write-Host "ğŸ”§ Inno Setupæœªå®‰è£…ï¼Œå¼€å§‹é€šè¿‡Chocolateyå®‰è£…..."
              choco install innosetup -y --no-progress --force
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "âŒ Chocolateyå®‰è£…Inno Setupå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
                  exit 1
              }
          } else {
              Write-Host "âœ… Inno Setupå·²é¢„è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          }

          # å¼ºåˆ¶æ‰§è¡ŒISCCéªŒè¯
          $isccTest = $false
          & ISCC.exe /? 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1) {
              $isccTest = $true
          }
          
          if ($isccTest) {
              Write-Host "âœ… Inno SetupéªŒè¯æˆåŠŸï¼ˆå¯æ­£å¸¸è°ƒç”¨ISCCç¼–è¯‘å™¨ï¼‰"
              Write-Host "ğŸ” å½“å‰å·¥ä½œç›®å½•ï¼š$(Get-Location)"
              Write-Host "ğŸ” ISCC.exeè·¯å¾„ï¼š$(Get-Command ISCC.exe | Select-Object -ExpandProperty Source)"
          } else {
              Write-Host "âŒ Inno SetupéªŒè¯å¤±è´¥"
              exit 1
          }
          
          # å¼ºåˆ¶é‡ç½®é€€å‡ºç ä¸º0
          $global:LASTEXITCODE = 0
          Write-Host "âœ… å¼ºåˆ¶é‡ç½®é€€å‡ºç ä¸º0ï¼Œæµç¨‹ç»§ç»­æ‰§è¡Œ"
        id: check-inno

      # ========== ç”ŸæˆInno Setupå®‰è£…åŒ…è„šæœ¬ ==========
      - name: ç”Ÿæˆ Inno Setup å®‰è£…åŒ…è„šæœ¬
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ å¼€å§‹ç”ŸæˆISSè„šæœ¬ï¼ˆé€‚é…æ–°ç‰ˆInno Setup+ç®¡ç†å‘˜æ ¡éªŒ+é™é»˜å¸è½½ï¼‰"
          # æ¸…ç©ºæ—§æ–‡ä»¶
          if (Test-Path "IPReportService.iss") { Remove-Item "IPReportService.iss" -Force }
          
          # é€è¡Œå†™å…¥ISSå†…å®¹ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šæ›¿æ¢åºŸå¼ƒçš„CheckWin32Versionï¼‰
          " [Setup]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Force
          " AppName=IPè‡ªåŠ¨ä¸ŠæŠ¥æœåŠ¡" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " AppVersion=1.0.0" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " DefaultDirName={pf}\IPReportService" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " DefaultGroupName=IPReportService" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " OutputDir=./installer" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          # æ–‡ä»¶åæ·»åŠ ç®¡ç†å‘˜æƒé™æç¤º
          " OutputBaseFilename=IPReportService-Setup(éœ€è¦ç®¡ç†å‘˜æƒé™)" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Compression=lzma" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " SolidCompression=yes" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          # å…¨å±€ç®¡ç†å‘˜æƒé™ï¼ˆæ–°ç‰ˆInno Setupæ¨èé…ç½®ï¼‰
          " PrivilegesRequired=admin" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          # é™é»˜å¸è½½é…ç½®
          " UninstallSilent=yes"                # å¸è½½é™é»˜æ‰§è¡Œ
          " UninstallNoConfirm=yes"             # å¸è½½ä¸å¼¹ç¡®è®¤æ¡†
          " UninstallDisplayIcon={app}\IPReportService.exe"
          " UninstallDisplayName=IPè‡ªåŠ¨ä¸ŠæŠ¥æœåŠ¡"
          " UninstallShowProgress=yes"          # æ˜¾ç¤ºå¸è½½è¿›åº¦
          " UninstallProgressFlags=nevershowmsg" # ä¸æ˜¾ç¤ºå¸è½½æ¶ˆæ¯å¼¹çª—
          # ç•Œé¢æ§åˆ¶
          " DisableWelcomePage=yes"
          " DisableProgramGroupPage=yes"
          " DisableReadyPage=yes"
          " DisableFinishedPage=yes"
          " DisableDirEdit=no"
          " DirExistsWarning=yes" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          # è¿›ç¨‹ç®¡ç†
          " SetupMutex=IPReportService-InstallMutex" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " CloseApplications=yes" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " CloseApplicationsFilter=IPReportService.exe" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # [Files]æ®µ
          " [Files]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Source: ""IPReportService.exe""; DestDir: ""{app}""; Flags: ignoreversion; Permissions: users-full" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # [Icons]æ®µ
          " [Icons]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Name: ""{group}\IPè‡ªåŠ¨ä¸ŠæŠ¥æœåŠ¡""; Filename: ""{app}\IPReportService.exe""" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Name: ""{group}\å¸è½½IPè‡ªåŠ¨ä¸ŠæŠ¥æœåŠ¡""; Filename: ""{uninstallexe}""" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # [Run]æ®µï¼ˆå®‰è£…åæ‰§è¡Œï¼‰
          " [Run]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Filename: ""{app}\IPReportService.exe""; Parameters: ""install""; Description: ""å®‰è£…å¹¶æ³¨å†ŒWindowsæœåŠ¡""; Flags: postinstall" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # [UninstallRun]æ®µï¼ˆé™é»˜å¸è½½ï¼‰
          " [UninstallRun]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Filename: ""taskkill.exe""; Parameters: ""/F /IM IPReportService.exe""; Flags: skipifdoesntexist runhidden nowait" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Filename: ""{app}\IPReportService.exe""; Parameters: ""uninstall""; Flags: skipifdoesntexist runhidden nowait" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # [UninstallDelete]æ®µ
          " [UninstallDelete]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " Type: filesandordirs; Name: ""{app}""" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # [Code]æ®µï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç§»é™¤åºŸå¼ƒçš„CheckWin32Versionï¼Œä»…ä¿ç•™IsAdminLoggedOnï¼‰
          " [Code]" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " function InitializeSetup(): Boolean;" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " var" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   IsAdmin: Boolean;" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " begin" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   // æ–°ç‰ˆInno Setupç›´æ¥ä½¿ç”¨IsAdminLoggedOn()æ ¡éªŒç®¡ç†å‘˜æƒé™ï¼ˆæ— éœ€ç³»ç»Ÿç‰ˆæœ¬æ ¡éªŒï¼‰" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   IsAdmin := IsAdminLoggedOn();" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   if not IsAdmin then" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   begin" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "     // å¼¹å‡ºé”™è¯¯æç¤ºæ¡†" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "     MsgBox('å½“å‰æœªä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œå®‰è£…åŒ…ï¼' + #13#10 + 'è¯·å³é”®ç‚¹å‡»å®‰è£…åŒ…ï¼Œé€‰æ‹©ã€Œä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œã€åé‡è¯•ã€‚', mbError, MB_OK);" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "     // è¿”å›Falseç»ˆæ­¢å®‰è£…" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "     Result := False;" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   end" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   else" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   begin" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "     // ç®¡ç†å‘˜æƒé™æ­£å¸¸ï¼Œç»§ç»­å®‰è£…" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "     Result := True;" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          "   end;" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          " end;" | Out-File -FilePath IPReportService.iss -Encoding UTF8 -Append
          
          # è½¬æ¢æ¢è¡Œç¬¦ä¸ºCRLFï¼ˆInno Setupè¦æ±‚ï¼‰
          $content = Get-Content IPReportService.iss -Raw
          $content -replace "`n", "`r`n" | Set-Content IPReportService.iss -Encoding UTF8 -Force
          
          Write-Host "âœ… ISSè„šæœ¬ç”ŸæˆæˆåŠŸï¼ˆé€‚é…æ–°ç‰ˆInno Setupï¼‰"
        id: generate-iss

      # ========== ç¼–è¯‘å®‰è£…åŒ… ==========
      - name: ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘å®‰è£…åŒ…"
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          
          # ç¼–è¯‘å®‰è£…åŒ…
          $issPath = (Resolve-Path IPReportService.iss).Path
          & ISCC.exe /O"./installer" /F"IPReportService-Setup(éœ€è¦ç®¡ç†å‘˜æƒé™)" "$issPath" 2>&1
          if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          
          # éªŒè¯å®‰è£…åŒ…
          $setupFile = "./installer/IPReportService-Setup(éœ€è¦ç®¡ç†å‘˜æƒé™).exe"
          if (Test-Path $setupFile) {
              $fileSize = (Get-Item $setupFile).Length
              Write-Host "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
              Write-Host "âœ… å®‰è£…åŒ…åç§°ï¼š$(Split-Path $setupFile -Leaf)"
          } else {
              Write-Host "âŒ æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶"
              exit 1
          }
        id: build-installer

      # ========== ä¸Šä¼ äº§ç‰© ==========
      - name: ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: IPReportService-Windows-Exe
          path: IPReportService.exe
          retention-days: 7
        id: upload-exe

      - name: ä¸Šä¼ å®‰è£…åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: IPReportService-Windows-Setup
          path: ./installer/IPReportService-Setup(éœ€è¦ç®¡ç†å‘˜æƒé™).exe
          retention-days: 7
        id: upload-installer

      - name: æœ€ç»ˆç¡®è®¤
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          Write-Host "âœ… Goç¨‹åºï¼š$(Test-Path IPReportService.exe)"
          Write-Host "âœ… ISSè„šæœ¬ï¼š$(Test-Path IPReportService.iss)"
          Write-Host "âœ… å®‰è£…åŒ…ï¼š$(Test-Path ./installer/IPReportService-Setup(éœ€è¦ç®¡ç†å‘˜æƒé™).exe)"
        id: final-check