name: Build GetIPviaWEB Service
on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # é€‚é…ä½ çš„Goç‰ˆæœ¬ï¼ˆå»ºè®®1.19+ï¼‰
          cache: true # å¯ç”¨Goæ¨¡å—ç¼“å­˜ï¼ŒåŠ é€Ÿç¼–è¯‘

      - name: éªŒè¯ GitHub Secrets æ˜¯å¦é…ç½®ï¼ˆä»…æ£€æŸ¥éç©ºï¼Œä¸æ‰“å°æ˜æ–‡ï¼‰
        run: |
          # ä»…æ£€æŸ¥Secretæ˜¯å¦å­˜åœ¨ï¼Œä¸æ‰“å°æ˜æ–‡
          if ("${{ secrets.IP_REPORT_API_KEY }}" -eq "") {
              echo "âŒ é”™è¯¯ï¼šIP_REPORT_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“Secretsä¸­æ·»åŠ è¯¥å¯†é’¥"
              exit 1
          } else {
              echo "âœ… IP_REPORT_API_KEY é…ç½®æ­£å¸¸ï¼ˆå·²éšè—æ˜æ–‡ï¼‰"
          }

      - name: ä¿®å¤æ¨¡å—æ ¡éªŒå’Œå¹¶æ•´ç†ä¾èµ–
        run: |
          # æ ¸å¿ƒï¼šæ¸…ç†æœ¬åœ°æ¨¡å—ç¼“å­˜ï¼Œè§£å†³æ ¡éªŒå’Œä¸åŒ¹é…é—®é¢˜
          go clean -modcache
          # é‡æ–°æ•´ç†ä¾èµ–ï¼ˆåŸºäºå·²æœ‰go.modï¼Œæ›´æ–°go.sumä¸ºæœ€æ–°æ ¡éªŒå’Œï¼‰
          go mod tidy

      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ³¨å…¥APIKeyï¼‰
        run: |
          # æ³¨å…¥GitHub Secretsä¸­çš„APIKeyåˆ°äºŒè¿›åˆ¶æ–‡ä»¶
          go build -o GetIPviaWEB.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          # éªŒè¯ç¼–è¯‘äº§ç‰©
          if (Test-Path "GetIPviaWEB.exe") {
              echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$(Get-Item GetIPviaWEB.exe | Select-Object -ExpandProperty Length) å­—èŠ‚"
          } else {
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
              exit 1
          }

      - name: å®‰è£…/éªŒè¯ Inno Setupï¼ˆè·³è¿‡é‡å¤å®‰è£…ï¼Œç›´æ¥éªŒè¯ï¼‰
        run: |
          # å…ˆæ£€æŸ¥ISCCæ˜¯å¦å·²å®‰è£…ï¼Œæœªå®‰è£…å†ç”¨chocoå®‰è£…
          if (-not (Get-Command "ISCC.exe" -ErrorAction SilentlyContinue)) {
              echo "ğŸ”§ Inno Setup æœªå®‰è£…ï¼Œå¼€å§‹é€šè¿‡Chocolateyå®‰è£…..."
              choco install innosetup -y --no-progress
          } else {
              echo "âœ… Inno Setup å·²é¢„è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          }
          
          # éªŒè¯å®‰è£…å¹¶è·å–ç‰ˆæœ¬ï¼ˆä¿®å¤ç‰ˆæœ¬å·æå–é€»è¾‘ï¼‰
          $isccVersion = & ISCC.exe /version 2>&1 | Select-String -Pattern "Inno Setup (\d+\.\d+\.\d+)"
          if ($isccVersion) {
              echo "âœ… Inno Setup å®‰è£…æˆåŠŸï¼Œç‰ˆæœ¬ï¼š$($isccVersion.Matches.Groups[1].Value)"
          } else {
              echo "âŒ Inno Setup å®‰è£…å¤±è´¥ï¼Œæ— æ³•è·å–ç‰ˆæœ¬å·"
              exit 1
          }

      - name: ç”Ÿæˆ Inno Setup å®‰è£…åŒ…è„šæœ¬ï¼ˆå·²åˆ é™¤4è¡Œå‘å¸ƒè€…é…ç½®ï¼‰
        run: |
          # å†™å…¥ Inno Setup é…ç½®è„šæœ¬ï¼ˆ.issï¼‰ï¼Œåˆ é™¤äº†AppPublisherç­‰4è¡Œé…ç½®
          @'
          [Setup]
          AppName=GetIPviaWEB Service
          AppVersion=1.0.0
          DefaultDirName={autopf}\GetIPviaWEB
          DefaultGroupName=GetIPviaWEB
          OutputDir=./installer
          OutputBaseFilename=GetIPviaWEB-Setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=lowest

          [Files]
          Source: "GetIPviaWEB.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"
          Name: "{commondesktop}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"; Flags: createonlyiffileexists

          [Run]
          Filename: "{app}\GetIPviaWEB.exe"; Description: "å¯åŠ¨ GetIPviaWEB æœåŠ¡"; Flags: postinstall skipifsilent

          [UninstallRun]
          Filename: "{app}\GetIPviaWEB.exe"; Parameters: "/uninstall"; Flags: skipifdoesntexist

          [UninstallDelete]
          Type: filesandordirs; Name: "{app}"
          '@ | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8
          echo "âœ… Inno Setup è„šæœ¬ç”Ÿæˆå®Œæˆï¼ˆå·²åˆ é™¤4è¡Œå‘å¸ƒè€…é…ç½®ï¼‰"

      - name: ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…ï¼ˆä¿®å¤ISCCè°ƒç”¨é€»è¾‘ï¼‰
        run: |
          # åˆ›å»ºå®‰è£…åŒ…è¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          
          # è°ƒç”¨ISCCç¼–è¯‘ï¼ŒæŒ‡å®šå®Œæ•´è„šæœ¬è·¯å¾„ï¼ˆè§£å†³å‚æ•°é”™è¯¯ï¼‰
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘å®‰è£…åŒ…ï¼Œè„šæœ¬è·¯å¾„ï¼š$((Get-Location).Path)\GetIPviaWEB.iss"
          & ISCC.exe /Q "$((Get-Location).Path)\GetIPviaWEB.iss"
          
          # æ£€æŸ¥ç¼–è¯‘é€€å‡ºç 
          if ($LASTEXITCODE -ne 0) {
              echo "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼ŒISCCé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          
          # éªŒè¯å®‰è£…åŒ…æ˜¯å¦ç”Ÿæˆ
          $setupFile = "./installer/GetIPviaWEB-Setup.exe"
          if (Test-Path $setupFile) {
              echo "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$(Get-Item $setupFile | Select-Object -ExpandProperty Length) å­—èŠ‚"
          } else {
              echo "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆå®‰è£…æ–‡ä»¶"
              exit 1
          }

      - name: ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Exe
          path: GetIPviaWEB.exe
          retention-days: 7

      - name: ä¸Šä¼ å›¾å½¢åŒ–å®‰è£…åŒ…äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Setup
          path: ./installer/GetIPviaWEB-Setup.exe
          retention-days: 7