name: Build GetIPviaWEB Service
on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
        working-directory: .
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        id: checkout
        continue-on-error: false

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
        id: setup-go
        continue-on-error: false

      - name: éªŒè¯ GitHub Secrets æ˜¯å¦é…ç½®
        run: |
          Write-Host "ğŸ” æ£€æŸ¥IP_REPORT_API_KEYé…ç½®çŠ¶æ€"
          if ("${{ secrets.IP_REPORT_API_KEY }}" -eq "") {
              Write-Error "âŒ IP_REPORT_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“Secretsä¸­æ·»åŠ è¯¥å¯†é’¥"
              exit 1
          } else {
              Write-Host "âœ… IP_REPORT_API_KEY é…ç½®æ­£å¸¸"
          }
        id: check-secret
        continue-on-error: false

      - name: ä¿®å¤æ¨¡å—æ ¡éªŒå’Œå¹¶æ•´ç†ä¾èµ–
        run: |
          Write-Host "ğŸ”§ æ¸…ç†Goæ¨¡å—ç¼“å­˜å¹¶æ•´ç†ä¾èµ–"
          go clean -modcache
          go mod tidy
          if ($LASTEXITCODE -ne 0) {
              Write-Error "âŒ go mod tidy æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          Write-Host "âœ… ä¾èµ–æ•´ç†å®Œæˆ"
        id: fix-mod
        continue-on-error: false

      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ³¨å…¥APIKeyï¼‰
        run: |
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘Goç¨‹åºï¼ˆæ³¨å…¥APIKeyï¼‰"
          go build -o GetIPviaWEB.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          if ($LASTEXITCODE -ne 0) {
              Write-Error "âŒ Goç¨‹åºç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          if (Test-Path "GetIPviaWEB.exe") {
              $fileSize = (Get-Item GetIPviaWEB.exe).Length
              Write-Host "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
          } else {
              Write-Error "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”ŸæˆGetIPviaWEB.exe"
              exit 1
          }
        id: build-exe
        continue-on-error: false

      - name: å®‰è£…/éªŒè¯ Inno Setup
        run: |
          Write-Host "ğŸ”§ æ£€æŸ¥Inno Setupå®‰è£…çŠ¶æ€"
          $isccExists = $false
          try {
              Get-Command "ISCC.exe" -ErrorAction Stop | Out-Null
              $isccExists = $true
          } catch {
              $isccExists = $false
          }

          if (-not $isccExists) {
              Write-Host "ğŸ”§ Inno Setupæœªå®‰è£…ï¼Œå¼€å§‹é€šè¿‡Chocolateyå®‰è£…..."
              choco install innosetup -y --no-progress --force
              if ($LASTEXITCODE -ne 0) {
                  Write-Error "âŒ Chocolateyå®‰è£…Inno Setupå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
                  exit 1
              }
          } else {
              Write-Host "âœ… Inno Setupå·²é¢„è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          }

          try {
              & ISCC.exe /? 2>&1 | Out-Null
              Write-Host "âœ… Inno SetupéªŒè¯æˆåŠŸï¼ˆå¯æ­£å¸¸è°ƒç”¨ISCCç¼–è¯‘å™¨ï¼‰"
          } catch {
              Write-Error "âŒ Inno SetupéªŒè¯å¤±è´¥ï¼Œå¼‚å¸¸ä¿¡æ¯ï¼š$_"
              exit 1
          }
        id: check-inno
        continue-on-error: false

      # ========== æ ¸å¿ƒä¿®å¤ï¼šæ‹†åˆ†ISSè„šæœ¬ç”Ÿæˆé€»è¾‘ï¼Œé¿å…YAMLå¤šè¡Œå­—ç¬¦ä¸²å†²çª ==========
      - name: ç”Ÿæˆ Inno Setup å®‰è£…åŒ…è„šæœ¬ï¼ˆæ— YAMLè¯­æ³•å†²çªï¼‰
        run: |
          Write-Host "ğŸ”§ ç”ŸæˆInno Setupé…ç½®è„šæœ¬ï¼ˆGetIPviaWEB.issï¼‰"
          
          # åˆ†æ­¥å†™å…¥ISSå†…å®¹ï¼Œé¿å…å¤šè¡Œå­—ç¬¦ä¸²è§¦å‘YAMLé”™è¯¯
          " [Setup]" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " AppName=GetIPviaWEB Service" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " AppVersion=1.0.0" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " DefaultDirName={autopf}\GetIPviaWEB" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " DefaultGroupName=GetIPviaWEB" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " OutputDir=./installer" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " OutputBaseFilename=GetIPviaWEB-Setup" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Compression=lzma" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " SolidCompression=yes" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " PrivilegesRequired=lowest" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " [Files]" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Source: ""GetIPviaWEB.exe""; DestDir: ""{app}""; Flags: ignoreversion" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " [Icons]" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Name: ""{group}\GetIPviaWEB Service""; Filename: ""{app}\GetIPviaWEB.exe""" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Name: ""{commondesktop}\GetIPviaWEB Service""; Filename: ""{app}\GetIPviaWEB.exe""; Flags: createonlyiffileexists" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " [Run]" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Filename: ""{app}\GetIPviaWEB.exe""; Description: ""å¯åŠ¨ GetIPviaWEB æœåŠ¡""; Flags: postinstall skipifsilent" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " [UninstallRun]" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Filename: ""{app}\GetIPviaWEB.exe""; Parameters: ""/uninstall""; Flags: skipifdoesntexist" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          "" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " [UninstallDelete]" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          " Type: filesandordirs; Name: ""{app}""" | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8 -Append
          
          # è½¬æ¢æ¢è¡Œç¬¦ä¸ºCRLFï¼ˆå…¼å®¹Inno Setupï¼‰
          $content = Get-Content GetIPviaWEB.iss -Raw
          $content -replace "`n", "`r`n" | Set-Content GetIPviaWEB.iss -Encoding UTF8
          
          # éªŒè¯ISSæ–‡ä»¶
          if (Test-Path "GetIPviaWEB.iss") {
              $fileSize = (Get-Item GetIPviaWEB.iss).Length
              Write-Host "âœ… ISSè„šæœ¬ç”ŸæˆæˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
          } else {
              Write-Error "âŒ ISSè„šæœ¬ç”Ÿæˆå¤±è´¥ï¼Œæœªåˆ›å»ºGetIPviaWEB.iss"
              exit 1
          }
        id: generate-iss
        continue-on-error: false

      - name: ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…
        run: |
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…"
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          
          $issPath = (Resolve-Path GetIPviaWEB.iss).Path
          Write-Host "ğŸ”§ ISSè„šæœ¬ç»å¯¹è·¯å¾„ï¼š$issPath"
          
          Write-Host "ğŸ”§ æ‰§è¡Œå‘½ä»¤ï¼šISCC.exe /O`"./installer`" /F`"GetIPviaWEB-Setup`" `"$issPath`""
          & ISCC.exe /O"./installer" /F"GetIPviaWEB-Setup" "$issPath"
          $compileExitCode = $LASTEXITCODE
          
          if ($compileExitCode -eq 0) {
              $setupFile = "./installer/GetIPviaWEB-Setup.exe"
              if (Test-Path $setupFile) {
                  $fileSize = (Get-Item $setupFile).Length
                  Write-Host "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
              } else {
                  Write-Error "âŒ ISCCç¼–è¯‘é€€å‡ºç ä¸º0ï¼Œä½†æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶ï¼š$setupFile"
                  exit 1
              }
          } else {
              Write-Error "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼ŒISCCé€€å‡ºç ï¼š$compileExitCode"
              exit 1
          }
        id: build-installer
        continue-on-error: false

      - name: ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Exe
          path: GetIPviaWEB.exe
          retention-days: 7
        id: upload-exe
        continue-on-error: false

      - name: ä¸Šä¼ å›¾å½¢åŒ–å®‰è£…åŒ…äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Setup
          path: ./installer/GetIPviaWEB-Setup.exe
          retention-days: 7
        id: upload-installer
        continue-on-error: false

      - name: æœ€ç»ˆç»“æœç¡®è®¤
        run: |
          Write-Host "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          Write-Host "âœ… Goç¨‹åºç¼–è¯‘æˆåŠŸï¼š$(Test-Path GetIPviaWEB.exe)"
          Write-Host "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼š$(Test-Path ./installer/GetIPviaWEB-Setup.exe)"
        id: final-check
        continue-on-error: false