name: Build GetIPviaWEB Service
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 支持手动触发

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # 适配你的Go版本（建议与本地开发一致）
          cache: true # 启用Go模块缓存，加速编译

      - name: 修复模块校验和并整理依赖
        run: |
          # 核心：清理本地模块缓存，解决校验和不匹配问题
          go clean -modcache
          # 重新整理依赖（基于已有go.mod，更新go.sum为最新校验和）
          go mod tidy

      - name: 编译可执行文件（注入APIKey）
        run: |
          # 注入GitHub Secrets中的APIKey到二进制文件
          go build -o GetIPviaWEB.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          # 验证编译产物
          if (Test-Path "GetIPviaWEB.exe") {
              echo "✅ 编译成功，文件大小：$(Get-Item GetIPviaWEB.exe | Select-Object -ExpandProperty Length) 字节"
          } else {
              echo "❌ 编译失败，未生成可执行文件"
              exit 1
          }

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Service
          path: GetIPviaWEB.exe
          retention-days: 7