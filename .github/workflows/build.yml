name: Build GetIPviaWEB Service
on:
  push:
    branches: [ main ]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # é€‚é…ä½ çš„Goç‰ˆæœ¬
          cache: true

      - name: éªŒè¯ GitHub Secrets æ˜¯å¦é…ç½®ï¼ˆä»…æ£€æŸ¥éç©ºï¼‰
        run: |
          if ("${{ secrets.IP_REPORT_API_KEY }}" -eq "") {
              echo "âŒ é”™è¯¯ï¼šIP_REPORT_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“Secretsä¸­æ·»åŠ è¯¥å¯†é’¥"
              exit 1
          } else {
              echo "âœ… IP_REPORT_API_KEY é…ç½®æ­£å¸¸ï¼ˆå·²éšè—æ˜æ–‡ï¼‰"
          }

      - name: ä¿®å¤æ¨¡å—æ ¡éªŒå’Œå¹¶æ•´ç†ä¾èµ–
        run: |
          go clean -modcache
          go mod tidy

      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ³¨å…¥APIKeyï¼‰
        run: |
          go build -o GetIPviaWEB.exe -ldflags="-s -w -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          if (Test-Path "GetIPviaWEB.exe") {
              echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$(Get-Item GetIPviaWEB.exe | Select-Object -ExpandProperty Length) å­—èŠ‚"
          } else {
              echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶"
              exit 1
          }

      - name: å®‰è£…/éªŒè¯ Inno Setupï¼ˆå…¼å®¹æ‰€æœ‰ç‰ˆæœ¬è¾“å‡ºæ ¼å¼ï¼‰
        run: |
          # æ­¥éª¤1ï¼šæ£€æŸ¥å¹¶å®‰è£…ISCCï¼ˆä»…æœªå®‰è£…æ—¶æ‰§è¡Œï¼‰
          if (-not (Get-Command "ISCC.exe" -ErrorAction SilentlyContinue)) {
              echo "ğŸ”§ Inno Setup æœªå®‰è£…ï¼Œå¼€å§‹é€šè¿‡Chocolateyå®‰è£…..."
              choco install innosetup -y --no-progress --force
          } else {
              echo "âœ… Inno Setup å·²é¢„è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          }

          # æ­¥éª¤2ï¼šéªŒè¯ISCCå¯ç”¨æ€§ï¼ˆæ ¸å¿ƒï¼šæ”¾å¼ƒå¤æ‚ç‰ˆæœ¬æå–ï¼Œä»…éªŒè¯å¯æ‰§è¡Œï¼‰
          try {
              # æ‰§è¡ŒISCC /? éªŒè¯æ˜¯å¦èƒ½æ­£å¸¸è°ƒç”¨ï¼Œé‡å®šå‘è¾“å‡ºé¿å…å†—ä½™
              & ISCC.exe /? 2>&1 | Out-Null
              if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1) { # ISCC /? é€€å‡ºç ä¸º1æ˜¯æ­£å¸¸çš„
                  echo "âœ… Inno Setup éªŒè¯æˆåŠŸï¼ˆå¯æ­£å¸¸è°ƒç”¨ISCCç¼–è¯‘å™¨ï¼‰"
              } else {
                  echo "âŒ Inno Setup éªŒè¯å¤±è´¥ï¼ŒISCCè°ƒç”¨å¼‚å¸¸ï¼ˆé€€å‡ºç ï¼š$LASTEXITCODEï¼‰"
                  exit 1
              }
          } catch {
              echo "âŒ Inno Setup éªŒè¯å¤±è´¥ï¼Œå¼‚å¸¸ä¿¡æ¯ï¼š$_"
              exit 1
          }

      - name: ç”Ÿæˆ Inno Setup å®‰è£…åŒ…è„šæœ¬
        run: |
          @'
          [Setup]
          AppName=GetIPviaWEB Service
          AppVersion=1.0.0
          DefaultDirName={autopf}\GetIPviaWEB
          DefaultGroupName=GetIPviaWEB
          OutputDir=./installer
          OutputBaseFilename=GetIPviaWEB-Setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=lowest

          [Files]
          Source: "GetIPviaWEB.exe"; DestDir: "{app}"; Flags: ignoreversion

          [Icons]
          Name: "{group}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"
          Name: "{commondesktop}\GetIPviaWEB Service"; Filename: "{app}\GetIPviaWEB.exe"; Flags: createonlyiffileexists

          [Run]
          Filename: "{app}\GetIPviaWEB.exe"; Description: "å¯åŠ¨ GetIPviaWEB æœåŠ¡"; Flags: postinstall skipifsilent

          [UninstallRun]
          Filename: "{app}\GetIPviaWEB.exe"; Parameters: "/uninstall"; Flags: skipifdoesntexist

          [UninstallDelete]
          Type: filesandordirs; Name: "{app}"
          '@ | Out-File -FilePath GetIPviaWEB.iss -Encoding UTF8
          echo "âœ… Inno Setup è„šæœ¬ç”Ÿæˆå®Œæˆ"

      - name: ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…ï¼ˆå¢å¼ºå®¹é”™ï¼‰
        run: |
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          
          # æ ¸å¿ƒï¼šè°ƒç”¨ISCCç¼–è¯‘ï¼Œå¼ºåˆ¶ä½¿ç”¨å®Œæ•´è·¯å¾„+è¯¦ç»†æ—¥å¿—
          $issPath = Resolve-Path GetIPviaWEB.iss
          echo "ğŸ”§ å¼€å§‹ç¼–è¯‘å®‰è£…åŒ…ï¼Œè„šæœ¬è·¯å¾„ï¼š$issPath"
          
          # æ‰§è¡Œç¼–è¯‘å¹¶æ•è·æ‰€æœ‰è¾“å‡º
          & ISCC.exe /O"./installer" /F"GetIPviaWEB-Setup" "$issPath" 2>&1
          $compileExitCode = $LASTEXITCODE
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if ($compileExitCode -eq 0) {
              $setupFile = "./installer/GetIPviaWEB-Setup.exe"
              if (Test-Path $setupFile) {
                  echo "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$(Get-Item $setupFile | Select-Object -ExpandProperty Length) å­—èŠ‚"
              } else {
                  echo "âš ï¸ ISCCç¼–è¯‘é€€å‡ºç ä¸º0ï¼Œä½†æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶"
                  exit 1
              }
          } else {
              echo "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼ŒISCCé€€å‡ºç ï¼š$compileExitCode"
              exit 1
          }

      - name: ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Exe
          path: GetIPviaWEB.exe
          retention-days: 7

      - name: ä¸Šä¼ å›¾å½¢åŒ–å®‰è£…åŒ…äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Setup
          path: ./installer/GetIPviaWEB-Setup.exe
          retention-days: 7