name: Build GetIPviaWEB
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh
        working-directory: .
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        id: checkout

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
        id: setup-go

      - name: éªŒè¯ GitHub Secrets æ˜¯å¦é…ç½®
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ” æ£€æŸ¥IP_REPORT_API_KEYé…ç½®çŠ¶æ€"
          if ("${{ secrets.IP_REPORT_API_KEY }}" -eq "") {
              Write-Host "âŒ IP_REPORT_API_KEY æœªé…ç½®ï¼Œè¯·åœ¨ä»“åº“Secretsä¸­æ·»åŠ è¯¥å¯†é’¥"
              exit 1
          } else {
              Write-Host "âœ… IP_REPORT_API_KEY é…ç½®æ­£å¸¸"
          }
        id: check-secret

      - name: ä¿®å¤æ¨¡å—æ ¡éªŒå’Œå¹¶æ•´ç†ä¾èµ–
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ æ¸…ç†Goæ¨¡å—ç¼“å­˜å¹¶æ•´ç†ä¾èµ–"
          go clean -modcache
          go mod tidy
          if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ go mod tidy æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          Write-Host "âœ… ä¾èµ–æ•´ç†å®Œæˆ"
        id: fix-mod

      - name: ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆæ³¨å…¥APIKeyï¼‰
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ å¼€å§‹ç¼–è¯‘Goç¨‹åºï¼ˆæ³¨å…¥APIKey+ç”ŸæˆGUIç¨‹åºï¼‰"
          go build -o GetIPviaWEB.exe -ldflags="-s -w -H windowsgui -X main.APIKey=${{ secrets.IP_REPORT_API_KEY }}" main.go
          if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ Goç¨‹åºç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              exit 1
          }
          if (Test-Path "GetIPviaWEB.exe") {
              $fileSize = (Get-Item GetIPviaWEB.exe).Length
              Write-Host "âœ… ç¼–è¯‘æˆåŠŸï¼Œæ–‡ä»¶å¤§å°ï¼š$fileSize å­—èŠ‚"
          } else {
              Write-Host "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœªç”ŸæˆGetIPviaWEB.exe"
              exit 1
          }
        id: build-exe

      - name: å®‰è£…/éªŒè¯ Inno Setup
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ æ£€æŸ¥Inno Setupå®‰è£…çŠ¶æ€"
          $isccExists = $false
          try {
              Get-Command "ISCC.exe" -ErrorAction SilentlyContinue | Out-Null
              $isccExists = $true
          } catch {
              $isccExists = $false
          }

          if (-not $isccExists) {
              Write-Host "ğŸ”§ Inno Setupæœªå®‰è£…ï¼Œå¼€å§‹é€šè¿‡Chocolateyå®‰è£…..."
              choco install innosetup -y --no-progress --force
              if ($LASTEXITCODE -ne 0) {
                  Write-Host "âŒ Chocolateyå®‰è£…Inno Setupå¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
                  exit 1
              }
          } else {
              Write-Host "âœ… Inno Setupå·²é¢„è£…ï¼Œè·³è¿‡å®‰è£…æ­¥éª¤"
          }

          $isccTest = $false
          & ISCC.exe /? 2>&1 | Out-Null
          if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1) {
              $isccTest = $true
          }
          
          if ($isccTest) {
              Write-Host "âœ… Inno Setup 6.7.0éªŒè¯æˆåŠŸ"
          } else {
              Write-Host "âŒ Inno SetupéªŒè¯å¤±è´¥"
              exit 1
          }
          
          $global:LASTEXITCODE = 0
          Write-Host "âœ… é‡ç½®é€€å‡ºç ï¼Œæµç¨‹ç»§ç»­"
        id: check-inno

      # ========== ç”ŸæˆISSè„šæœ¬ï¼ˆYAMLè¯­æ³•åˆè§„+Typeå‚æ•°ä¿®å¤ï¼‰ ==========
      - name: ç”Ÿæˆ Inno Setup å®‰è£…åŒ…è„šæœ¬
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ ç”ŸæˆISSè„šæœ¬ï¼ˆYAMLå…¼å®¹+æ— éšå½¢å­—ç¬¦ï¼‰"
          # å…ˆåˆ é™¤æ—§æ–‡ä»¶
          if (Test-Path "GetIPviaWEB.iss") { Remove-Item "GetIPviaWEB.iss" -Force }
          
          # æ ¸å¿ƒï¼šç”¨echoé€è¡Œå†™å…¥ï¼ˆYAMLæœ€å…¼å®¹çš„æ–¹å¼ï¼Œæ— å­—ç¬¦ä¸²å†²çªï¼‰
          # æ‰€æœ‰è¡Œå‡ä¸ºçº¯ASCIIå­—ç¬¦ï¼Œæ— éšå½¢å­—ç¬¦ï¼Œåˆ†å·åæ˜¯åŠè§’ç©ºæ ¼
          echo '[Setup]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'AppName=GetIPviaWEB' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'AppVersion=1.0.0' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'DefaultDirName={pf}\GetIPviaWEB' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'DefaultGroupName=GetIPviaWEB' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'OutputDir=./installer' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'OutputBaseFilename=GetIPviaWEB-Setup' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Compression=lzma' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'SolidCompression=yes' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'PrivilegesRequired=admin' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'SetupMutex=GetIPviaWEB-InstallMutex' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'CloseApplications=yes' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'CloseApplicationsFilter=GetIPviaWEB.exe' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '[Files]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Source: "GetIPviaWEB.exe"; DestDir: "{app}"' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '[Icons]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Name: "{group}\GetIPviaWEB"; Filename: "{app}\GetIPviaWEB.exe"' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Name: "{group}\å¸è½½GetIPviaWEB"; Filename: "{uninstallexe}"; Parameters: "/VERYSILENT"' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '[Run]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Filename: "{app}\GetIPviaWEB.exe"; Parameters: "install"; Flags: runhidden' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '[UninstallRun]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Filename: "taskkill.exe"; Parameters: "/F /IM GetIPviaWEB.exe"; Flags: skipifdoesntexist runhidden nowait' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Filename: "{app}\GetIPviaWEB.exe"; Parameters: "uninstall"; Flags: skipifdoesntexist runhidden nowait' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Filename: "cmd.exe"; Parameters: "/c rmdir /s /q ""{app}"""; Flags: skipifdoesntexist runhidden nowait' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '[UninstallDelete]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          # å…³é”®ï¼šTypeå‚æ•°ä¸¥æ ¼åˆè§„ï¼Œæ— ä»»ä½•éšå½¢å­—ç¬¦
          echo 'Type: files; Name: "{app}\*.*"' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'Type: dirs; Name: "{app}"' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '[Code]' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'function InitializeSetup(): Boolean;' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'var' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  IsAdmin: Boolean;' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'begin' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  IsAdmin := IsAdminLoggedOn();' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  if not IsAdmin then' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  begin' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '    MsgBox(''è¯·ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå®‰è£…åŒ…ï¼'' + #13#10 + ''å³é”® â†’ ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ'', mbError, MB_OK);' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '    Result := False;' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  end' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  else' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  begin' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '    Result := True;' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo '  end;' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          echo 'end;' | Out-File -FilePath GetIPviaWEB.iss -Encoding utf8NoBOM -Append
          
          # å¼ºåˆ¶è½¬æ¢ä¸ºCRLFæ¢è¡Œï¼ˆInno Setupè¦æ±‚ï¼‰
          $content = Get-Content GetIPviaWEB.iss -Raw
          $content = $content -replace "`n", "`r`n"
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          [System.IO.File]::WriteAllText("$PWD/GetIPviaWEB.iss", $content, $utf8NoBom)
          
          # éªŒè¯[UninstallDelete]æ®µå†…å®¹
          Write-Host "ğŸ” éªŒè¯[UninstallDelete]æ®µå†…å®¹ï¼š"
          $udLines = Get-Content GetIPviaWEB.iss | Where-Object { $_ -match 'Type: files|Type: dirs' }
          foreach ($line in $udLines) {
              Write-Host "è¡Œå†…å®¹ï¼š$line"
              # æ‰“å°ASCIIç ï¼Œç¡®ä¿æ— å¼‚å¸¸
              $ascii = $line.ToCharArray() | ForEach-Object { [int]$_ }
              Write-Host "ASCIIç ï¼š$($ascii -join ', ')"
          }
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ
          if (Test-Path "GetIPviaWEB.iss") {
              $size = (Get-Item GetIPviaWEB.iss).Length
              Write-Host "âœ… ISSè„šæœ¬ç”ŸæˆæˆåŠŸï¼Œå¤§å°ï¼š$size å­—èŠ‚"
          } else {
              Write-Host "âŒ ISSè„šæœ¬ç”Ÿæˆå¤±è´¥"
              exit 1
          }
        id: generate-iss

      # ========== ç¼–è¯‘å®‰è£…åŒ… ==========
      - name: ç¼–è¯‘å›¾å½¢åŒ–å®‰è£…åŒ…
        run: |
          Set-StrictMode -Off
          $ErrorActionPreference = 'Continue'
          
          Write-Host "ğŸ”§ ç¼–è¯‘å®‰è£…åŒ…ï¼ˆISCC 6.7.0 æ ¸å¿ƒå‘½ä»¤ï¼‰"
          # åˆ›å»ºè¾“å‡ºç›®å½•
          New-Item -ItemType Directory -Path ./installer -Force | Out-Null
          
          # è·å–ISSæ–‡ä»¶è·¯å¾„
          $issPath = (Resolve-Path GetIPviaWEB.iss).Path
          # æ‰§è¡Œç¼–è¯‘
          & ISCC.exe "$issPath" /O"./installer" /F"GetIPviaWEB-Setup" 2>&1
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if ($LASTEXITCODE -ne 0) {
              Write-Host "âŒ å®‰è£…åŒ…ç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºç ï¼š$LASTEXITCODE"
              # æ‰“å°ISSæ–‡ä»¶å†…å®¹ä¾¿äºæ’æŸ¥
              Write-Host "ğŸ” ISSæ–‡ä»¶å®Œæ•´å†…å®¹ï¼š"
              Get-Content GetIPviaWEB.iss
              exit 1
          }
          
          # éªŒè¯å®‰è£…åŒ…
          $setupFile = "./installer/GetIPviaWEB-Setup.exe"
          if (Test-Path $setupFile) {
              $size = (Get-Item $setupFile).Length
              Write-Host "âœ… å®‰è£…åŒ…ç¼–è¯‘æˆåŠŸï¼å¤§å°ï¼š$size å­—èŠ‚"
              Write-Host "âœ… è·¯å¾„ï¼š$setupFile"
          } else {
              Write-Host "âŒ æœªæ‰¾åˆ°å®‰è£…åŒ…æ–‡ä»¶"
              exit 1
          }
        id: build-installer

      # ========== ä¸Šä¼ äº§ç‰© ==========
      - name: ä¸Šä¼ å¯æ‰§è¡Œæ–‡ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Exe
          path: GetIPviaWEB.exe
          retention-days: 7
        id: upload-exe

      - name: ä¸Šä¼ å®‰è£…åŒ…
        uses: actions/upload-artifact@v4
        with:
          name: GetIPviaWEB-Windows-Setup
          path: ./installer/GetIPviaWEB-Setup.exe
          retention-days: 7
        id: upload-installer

      - name: æœ€ç»ˆç¡®è®¤
        run: |
          Set-StrictMode -Off
          Write-Host "ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼"
          Write-Host "âœ… Goç¨‹åºï¼š$(Test-Path GetIPviaWEB.exe)"
          Write-Host "âœ… ISSè„šæœ¬ï¼š$(Test-Path GetIPviaWEB.iss)"
          Write-Host "âœ… å®‰è£…åŒ…ï¼š$(Test-Path ./installer/GetIPviaWEB-Setup.exe)"
        id: final-check