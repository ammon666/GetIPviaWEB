# Windows IP监控系统 - 架构设计文档

## 1. 系统概述

这是一个轻量级的Windows设备IP地址监控系统，用于实时追踪多台Windows设备的网络信息变化。

### 1.1 设计目标

- ✅ **轻量化**：客户端程序体积小（2-3MB），无需额外运行时
- ✅ **自动化**：开机自启，自动监控，无需人工干预
- ✅ **实时性**：IP变化立即上报，定时心跳检查
- ✅ **易部署**：GitHub Actions自动构建，一键部署
- ✅ **低成本**：使用Cloudflare免费服务，支持中小规模使用

### 1.2 技术选型

| 组件 | 技术 | 理由 |
|------|------|------|
| 客户端 | Go 1.21 | 编译为单个exe，无运行时依赖，跨平台支持 |
| 服务端 | Cloudflare Workers | 免费、全球CDN、自带HTTPS、KV存储 |
| 构建系统 | GitHub Actions | 自动化CI/CD，免费 |
| UI库 | lxn/walk | Windows原生GUI，轻量级 |

## 2. 系统架构

### 2.1 整体架构图

```
┌──────────────────────────────────────────────────────────┐
│                     GitHub仓库                           │
│                                                          │
│  ┌────────────┐         ┌──────────────┐                │
│  │  源代码    │────────>│GitHub Actions│                │
│  │  main.go   │         │  自动编译    │                │
│  └────────────┘         └──────┬───────┘                │
│                                 │                        │
│                          [生成exe文件]                   │
└─────────────────────────────────┼────────────────────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │  ip-monitor.exe │
                         │                 │
                         │  部署到Windows  │
                         └────────┬────────┘
                                  │
        ┌─────────────────────────┼─────────────────────────┐
        │                         │                         │
        ▼                         ▼                         ▼
   [启动时运行]            [每小时运行]              [IP变化时运行]
        │                         │                         │
        └─────────────────────────┴─────────────────────────┘
                                  │
                          [收集系统信息]
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
                    ▼             ▼             ▼
              [获取网络]    [获取用户]    [加载UUID]
                    │             │             │
                    └─────────────┴─────────────┘
                                  │
                         [HTTPS POST请求]
                                  │
                                  ▼
                    ┌──────────────────────────┐
                    │  Cloudflare Workers      │
                    │                          │
                    │  ┌────────────────────┐  │
                    │  │  验证API Key       │  │
                    │  └──────┬─────────────┘  │
                    │         │                │
                    │         ▼                │
                    │  ┌────────────────────┐  │
                    │  │  存储到KV数据库    │  │
                    │  │  - 当前数据        │  │
                    │  │  - 历史记录(50条)  │  │
                    │  └────────────────────┘  │
                    │                          │
                    │  ┌────────────────────┐  │
                    │  │  提供查询接口      │  │
                    │  │  /view/{UUID}      │  │
                    │  └────────────────────┘  │
                    └──────────────────────────┘
                                  │
                                  ▼
                         [Web查询界面]
                    显示IP、用户名、历史记录
```

### 2.2 数据流程

```
客户端数据采集流程：
1. 程序启动
   ↓
2. 检查UUID配置文件
   ├─ 存在 → 读取UUID
   └─ 不存在 → 生成新UUID并保存
   ↓
3. 获取系统信息
   ├─ 当前登录用户名 (user.Current())
   ├─ 主机名 (os.Hostname())
   └─ 网络接口信息 (net.Interfaces())
       ├─ 过滤：只保留启用的、非回环的接口
       ├─ 获取IPv4地址
       ├─ 计算子网掩码
       └─ 推导网关地址
   ↓
4. 构造JSON数据包
   {
     "uuid": "xxx",
     "username": "xxx",
     "hostname": "xxx",
     "networks": [...],
     "timestamp": "xxx"
   }
   ↓
5. HTTPS POST到Cloudflare
   Header: X-API-Key: xxx
   ↓
6. 记录日志并更新GUI
   ↓
7. 进入监控循环
   ├─ 每小时执行一次上报
   └─ 每5分钟检查IP是否变化
       └─ 变化则立即上报
```

## 3. 核心功能实现

### 3.1 UUID生成与持久化

**存储位置**：`%APPDATA%\IPMonitor\config.json`

**实现逻辑**：
```go
// 首次运行
if 配置文件不存在:
    uuid = 生成新UUID
    保存到配置文件
else:
    uuid = 从配置文件读取
```

**持久化保证**：
- 存储在用户AppData目录，不受程序重新安装影响
- JSON格式，易于查看和修改
- 只在首次运行时生成，确保UUID稳定性

### 3.2 网络信息获取

**获取逻辑**：
```go
interfaces = net.Interfaces()  // 获取所有网络接口

for each interface:
    if 未启用 or 是回环接口:
        continue  // 跳过
    
    addresses = interface.Addrs()
    for each address:
        if 是IPv4地址:
            记录：
            - 接口名称
            - IP地址
            - 子网掩码
            - 网关（推导）
```

**网关推导算法**：
```
IP地址: 192.168.1.100
网关推导: 192.168.1.1 (将最后一位改为1)
```

### 3.3 IP变化检测

**检测机制**：
```
主循环:
    每5分钟执行一次:
        current_networks = 获取当前网络信息
        if current_networks != last_networks:
            执行上报
            last_networks = current_networks
```

**比较逻辑**：
- 比较网络接口数量
- 逐个比较IP地址和网关
- 任一不同即判定为变化

### 3.4 定时上报

**触发条件**：
1. 程序启动时立即上报
2. 每1小时定时上报（可配置）
3. IP地址变化时立即上报
4. 系统重启后立即上报（因为程序会自启）

### 3.5 日志系统

**日志输出**：
- GUI窗口实时显示
- 写入日志文件：`%APPDATA%\IPMonitor\monitor.log`
- 控制台输出（调试用）

**日志级别**：
```
[时间戳] 日志内容
示例：[2024-01-15 10:30:45] 数据已成功发送到Cloudflare
```

## 4. 服务端实现

### 4.1 Cloudflare Workers路由

```
/ (GET)
└─ 显示首页说明

/api/report (POST)
├─ 验证API Key
├─ 验证数据格式
├─ 存储当前数据 → device_{uuid}
├─ 追加历史记录 → history_{uuid}
└─ 返回成功响应

/view/{uuid} (GET)
├─ 查询 device_{uuid}
├─ 查询 history_{uuid}
├─ 生成HTML页面
└─ 返回给用户
```

### 4.2 KV存储结构

**当前数据键**：`device_{uuid}`
```json
{
  "uuid": "xxx",
  "username": "xxx",
  "hostname": "xxx",
  "networks": [...],
  "timestamp": "2024-01-15T10:30:45Z",
  "lastUpdate": "2024-01-15T10:30:45Z"
}
```

**历史记录键**：`history_{uuid}`
```json
[
  {
    "timestamp": "2024-01-15T10:30:45Z",
    "username": "xxx",
    "hostname": "xxx",
    "networks": [...]
  },
  // ... 最多保存50条
]
```

**过期策略**：
- TTL：90天（7,776,000秒）
- 超过90天自动删除

### 4.3 安全机制

**API密钥验证**：
```javascript
const apiKey = request.headers.get('X-API-Key');
if (apiKey !== API_KEY) {
    return 401 Unauthorized;
}
```

**CORS支持**：
- 允许跨域访问
- 支持OPTIONS预检请求

**数据隔离**：
- 每个UUID独立存储
- 通过UUID访问，无法遍历其他设备

## 5. GitHub Actions构建流程

### 5.1 触发条件

- Push到main/master分支
- 创建Tag（v*格式）
- 手动触发（workflow_dispatch）

### 5.2 构建步骤

```yaml
1. Checkout代码
   ↓
2. 设置Go环境 (1.21)
   ↓
3. 下载依赖 (go mod download)
   ↓
4. 编译程序
   go build -ldflags="-s -w -H windowsgui" -o ip-monitor.exe
   ├─ -s -w : 去除调试信息，减小体积
   └─ -H windowsgui : Windows GUI程序（无控制台窗口）
   ↓
5. 生成构建信息
   build-info.txt
   ↓
6. 上传Artifact
   ↓
7. (如果是Tag) 创建Release
```

### 5.3 构建优化

**体积优化**：
```bash
# 基础编译：~5MB
go build -o ip-monitor.exe

# 去除调试信息：~2-3MB
go build -ldflags="-s -w" -o ip-monitor.exe

# 可选UPX压缩：~1-2MB
upx --best ip-monitor.exe
```

## 6. 部署架构

### 6.1 客户端部署

```
Windows设备
├─ C:\Program Files\IPMonitor\
│  └─ ip-monitor.exe
│
└─ %APPDATA%\IPMonitor\
   ├─ config.json (UUID配置)
   └─ monitor.log (运行日志)

开机自启:
├─ 方式1: 任务计划程序 (推荐)
│  └─ 触发器: 系统启动时
│  └─ 可在登录前运行
│
└─ 方式2: 启动文件夹
   └─ 快捷方式放入StartUp目录
   └─ 需要用户登录后才运行
```

### 6.2 服务端部署

```
Cloudflare
├─ Workers
│  ├─ worker.js (主程序)
│  └─ URL: https://xxx.workers.dev
│
└─ KV存储
   ├─ IP_MONITOR_KV
   ├─ 免费额度: 每天1000次写入
   └─ 数据自动过期: 90天
```

## 7. 性能与容量规划

### 7.1 单设备资源消耗

**客户端**：
- 内存占用：~10-20MB
- CPU占用：几乎为0（除上报瞬间）
- 网络流量：每次上报 <1KB
- 磁盘占用：
  - 程序：2-3MB
  - 配置：<1KB
  - 日志：增长缓慢（每天约10KB）

**服务端（每设备）**：
- KV写入：24次/天（每小时1次）
- KV读取：取决于查询频率
- KV存储：每设备 <10KB

### 7.2 扩展能力

**Cloudflare免费额度**：
- 每天100,000次请求 → 可支持约4000台设备
- 每天1,000次KV写入 → 实际瓶颈（可支持约40台设备）

**解决方案**：
1. 调整上报频率（如改为2小时）→ 支持80台设备
2. 升级付费计划（$5/月）→ 无限制
3. 使用其他存储（如R2、D1数据库）

### 7.3 网络优化

- Cloudflare全球CDN，低延迟
- HTTPS连接复用
- JSON压缩传输
- 失败自动重试（待实现）

## 8. 安全考虑

### 8.1 认证机制

```
客户端 → 服务端:
    Header: X-API-Key: [密钥]
    
服务端验证:
    if (apiKey == API_KEY):
        允许访问
    else:
        拒绝 (401)
```

### 8.2 数据传输

- 强制HTTPS加密
- API密钥不在URL中
- 不使用Cookie或Session

### 8.3 访问控制

- UUID作为访问凭证
- 无法枚举或遍历其他设备
- 查询页面无需额外认证（依赖UUID保密）

### 8.4 数据隐私

**存储的数据**：
- UUID（匿名标识）
- 用户名（Windows登录名）
- 主机名
- IP地址、网关、子网掩码

**不存储的数据**：
- 密码
- 个人文件
- 浏览历史
- 其他敏感信息

### 8.5 潜在风险

1. **API密钥泄露**：
   - 风险：他人可伪造数据
   - 缓解：定期更换密钥，监控异常

2. **UUID泄露**：
   - 风险：他人可查看设备信息
   - 缓解：不在公共场合分享查询链接

3. **中间人攻击**：
   - 风险：HTTPS降级攻击
   - 缓解：证书锁定（待实现）

## 9. 监控与运维

### 9.1 健康检查

**客户端**：
- 查看日志文件最后更新时间
- 检查上报成功率

**服务端**：
- Cloudflare Analytics查看请求量
- KV存储使用量监控

### 9.2 故障排查

**常见问题**：
```
1. 未收到数据
   → 检查客户端日志
   → 验证网络连接
   → 确认API密钥

2. 查询页面404
   → 确认UUID正确
   → 检查数据是否过期
   → 查看Worker部署状态

3. 编译失败
   → 检查Go版本
   → 运行go mod tidy
   → 查看Actions日志
```

### 9.3 日志分析

**客户端日志示例**：
```
[2024-01-15 10:30:45] ========== 程序启动 ==========
[2024-01-15 10:30:45] 配置目录: C:\Users\xxx\AppData\Roaming\IPMonitor
[2024-01-15 10:30:45] 已加载现有UUID: xxx-xxx-xxx
[2024-01-15 10:30:46] 收集到的信息:
[2024-01-15 10:30:46]   UUID: xxx
[2024-01-15 10:30:46]   用户名: DESKTOP\user
[2024-01-15 10:30:47] 数据已成功发送到Cloudflare
```

## 10. 未来改进方向

### 10.1 短期计划

- [ ] 添加失败重试机制
- [ ] 支持配置文件（可调整上报间隔等）
- [ ] 支持IPv6地址
- [ ] 更精确的网关检测

### 10.2 中期计划

- [ ] Web管理后台（多设备管理）
- [ ] 邮件/Webhook通知（IP变化时）
- [ ] 数据导出功能
- [ ] 图表展示IP变化趋势

### 10.3 长期计划

- [ ] 支持Linux/macOS客户端
- [ ] 移动端查询应用
- [ ] 地理位置跟踪（基于IP）
- [ ] 设备分组管理

## 11. 技术债务

- [ ] 网关检测方法过于简单（推导法）
- [ ] 缺少异常处理的单元测试
- [ ] 日志文件无大小限制（可能无限增长）
- [ ] GUI窗口关闭不退出程序（设计如此）

## 12. 参考资料

- [Go net包文档](https://pkg.go.dev/net)
- [Cloudflare Workers文档](https://developers.cloudflare.com/workers/)
- [GitHub Actions文档](https://docs.github.com/en/actions)
- [lxn/walk GUI库](https://github.com/lxn/walk)

---

**文档版本**: v1.0  
**最后更新**: 2024-01-15  
**维护者**: 开发团队
